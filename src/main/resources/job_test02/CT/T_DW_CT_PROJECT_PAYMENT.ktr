<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>T_DW_CT_PROJECT_PAYMENT</name>
    <description />
    <extended_description />
    <trans_version />
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection />
        <schema />
        <table />
        <size_limit_lines />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject />
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject />
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject />
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject />
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection />
        <schema />
        <table />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection />
      <table />
      <field />
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file />
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2020/06/28 11:26:56.502</created_date>
    <modified_user>-</modified_user>
    <modified_date>2020/06/28 11:26:56.502</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
     <name>oracle</name>
    <server>10.12.81.8</server>
    <type>ORACLE</type>
    <access>Native</access>
    <database>report</database>
    <port>1521</port>
    <username>fsscreport</username>
    <password>LsY6kPWYuJZf1SsY</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1521</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>成本台账项目付款单明细表</from>
      <to>插入 / 更新</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>成本台账项目付款单明细表</name>
    <type>TableInput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>oracle</connection>
    <sql>with base as (--分期、分期排序
 select b.*
      ,rank() over(partition by nvl(b.djbh,b.explanation),b.datekey order by decode(substr(nvl(fq1, '不分期'), 1, instr(nvl(fq1, '不分期'), '期' ，1) - 1), '一', 1, '二', 2, '三', 3, '四', 4, '五', 5, '六', 6, '七', 7, '八', 8, '九', 9, '十', 10, '十一', 11, '十二', 12, '十三', 13, '十四', 14, '十五', 15, '十六', 16, '十七', 17, '十八', 18, '十九', 19, '二十', 20, '不分', 100)) rank
  from (select a.*
              ,case
                 when substr(fq, 1, 1) in
                      ('一', '二', '三', '四', '五', '六', '七', '八', '九', '十') then
                  fq
                 else
                  case
                    when substr(fq, 2, 1) in
                         ('一', '二', '三', '四', '五', '六', '七', '八', '九', '十') then
                     substr(fq, 2)
                    else
                     case
                       when substr(fq, 3, 1) in
                            ('一', '二', '三', '四', '五', '六', '七', '八', '九', '十') then
                        substr(fq, 3)
                     end
                  end
               end fq1 --分期
          from (select t.*
                      ,case
                         when instr(fuzhuname, '期', 1, 1) = 0 then
                          null
                         else
                          substr(fuzhuname, instr(fuzhuname, '期', 1, 1) - 2, 3)
                       end fq
                  from ods_ct_cost_detail t) a
       -- where  djbh='CQHTFK202007022210'
      -- where datekey&lt;'2020-07'
        ) b
 order by b.djbh
 ),

base2 as
 (select yearv --年
        ,periodv --月
        ,name company_name --公司名称
        ,t.djbh --单据编号
        ,explanation --摘要内容
        ,laiyuan --来源
        ,nvl(contractcode, t.djbh) contractcode --合同编号
        ,nvl(httypename, t.djbh) httypename --合同类别
        ,nvl(contractname, t.djbh) contractname --合同名称
        ,nvl(x_dfprovidernames, t.djbh) x_dfprovidernames --对方单位
        ,nvl(jsstate, t.djbh) jsstate --结算状态
        ,nvl(x_totalamount_inputtax, 0) x_totalamount_tax --合同最新金额（含税）
        ,nvl(x_totalamount_nontax, 0) x_totalamount_nontax --合同最新金额（不含税）
        ,nvl(fq1, '不分期') fq --分期
        ,null localdebitamount_jjfy --账面开发间接费用
        ,sum(nvl(localdebitamount_td, 0)) +
         sum(nvl(localdebitamount_qq, 0)) +
         sum(nvl(localdebitamount_ja, 0)) +
         sum(nvl(localdebitamount_jc, 0)) +
         sum(nvl(localdebitamount_pt, 0)) +
         sum(nvl(localdebitamount_hj, 0)) +
         sum(nvl(localdebitamount_gcxg, 0)) +
         sum(nvl(localdebitamount_gcyg, 0)) +
         sum(nvl(localdebitamount_gchx, 0)) +
         sum(nvl(localdebitamount_kfjj, 0)) localdebitamount --账面开发成本
        ,sum(nvl(localdebitamount_td, 0)) localdebitamount_td --土地费用
        ,sum(nvl(localdebitamount_qq, 0)) localdebitamount_qq --前期工程费
        ,sum(nvl(localdebitamount_ja, 0)) localdebitamount_ja --建安工程费
        ,sum(nvl(localdebitamount_jc, 0)) localdebitamount_jc --基础设施费
        ,sum(nvl(localdebitamount_pt, 0)) localdebitamount_pt --配套设施费
        ,sum(nvl(localdebitamount_hj, 0)) localdebitamount_hj --环境景观工程费
        ,sum(nvl(localdebitamount_gcxg, 0)) localdebitamount_gcxg --工程相关费
        ,sum(nvl(localdebitamount_gcyg, 0)) localdebitamount_gcyg --工程预估成本
        ,sum(nvl(localdebitamount_gchx, 0)) localdebitamount_gchx --工程后续成本
        ,sum(nvl(localdebitamount_kfjj, 0)) localdebitamount_kfjj --开发间接费转入
        ,sum(nvl(qp_amount, 0)) + sum(nvl(qp_amount_hs, 0)) qp_amount_hs1 --nc取票金额（含税）
        ,sum(nvl(qp_amount, 0)) qp_amount --nc取票金额（不含税）
        ,sum(nvl(qp_amount_hs, 0)) qp_amount_hs --nc取票金额（可抵扣税额）
        ,sum(nvl(creditamount, 0)) creditamount --贷方累计发生
        ,nvl(x_amount, 0) x_amount --成本取票金额（含税）
        ,nvl(x_amount_nontax, 0) x_amount_nontax --成本取票金额（不含税）
        ,nvl(x_inputtax, 0) x_inputtax --成本取票金额（可抵扣税额）
        ,case when rank=1 then m.debitamount else 0 end  debitamount--借方累计发生（nc付款金额）
        ,nvl(applyamount_bz, 0) applyamount_bz --成本付款金额
        ,nvl(x_paymentamount, 0) x_paymentamount --合计
        ,nvl(x_paymentamount_xj, 0) x_paymentamount_xj --现金
        ,nvl(x_paymentamount_sp, 0) x_paymentamount_sp --商票
        ,nvl(x_paymentamount_bl, 0) x_paymentamount_bl --保理
        ,nvl(x_offsetamount_bz, 0) x_offsetamount_bz --扣罚款
        ,nvl(nov,'0') nov --凭证
        ,nvl(hx_nov,'0') hx_nov --核销凭证
        ,t.datekey --年月
        ,1 gz --规则
        ,case
           when to_char(sysdate-1 , 'dd') > t.datekey then
            '1'
           else
            '0'
         end issb --锁板标识
    from base t
    left join (select djbh,datekey
                    ,sum(nvl(debitamount, 0)) debitamount --借方累计发生
                from base
               where subjcode like '212102'
               group by djbh,datekey) m
      on t.djbh = m.djbh and t.datekey=m.datekey
  --科目为nc开发成本（4101）-三栏式明细账-凭证-摘要抓取付款单号
   where t.djbh is not null
     and subjcode like '4101%'
   group by yearv
           ,periodv
           ,name --公司名称
           ,t.djbh
           ,explanation
           ,laiyuan
           ,nov
           ,hx_nov
           ,httypename
           ,contractname
           ,x_dfprovidernames
           ,jsstate
           ,t.datekey
           ,fq1
           ,contractcode
           ,m.debitamount
           ,nvl(x_totalamount_inputtax, 0) --合同最新金额（含税）
           ,nvl(x_totalamount_nontax, 0) --合同最新金额（不含税）
           ,nvl(x_amount, 0) --成本取票金额（含税）
           ,nvl(x_amount_nontax, 0) --成本取票金额（不含税）
           ,nvl(x_inputtax, 0) --成本取票金额（可抵扣税额）
           ,nvl(applyamount_bz, 0) --成本付款金额
           ,nvl(x_paymentamount, 0) --合计
           ,nvl(x_paymentamount_xj, 0) --现金
           ,nvl(x_paymentamount_sp, 0) --商票
           ,nvl(x_paymentamount_bl, 0) --保理
           ,nvl(x_offsetamount_bz, 0) --扣罚款
           ,case when rank=1 then m.debitamount else 0 end
  ),
base3 as
 (select yearv --年
        ,periodv --月
        ,name company_name --公司名称
        ,djbh --单据编号
        ,explanation --摘要内容
        ,laiyuan --来源
        ,nvl(contractcode, explanation) contractcode --合同编号
        ,httypename --合同类别
        ,contractname --合同名称
        ,x_dfprovidernames --对方单位
        ,jsstate --结算状态
        ,nvl(x_totalamount_inputtax, 0) x_totalamount_tax --合同最新金额（含税）
        ,nvl(x_totalamount_nontax, 0) x_totalamount_nontax --合同最新金额（不含税）
        ,'不分期' fq --分期
        ,null localdebitamount_jjfy --账面开发间接费用
        ,null localdebitamount --账面开发成本
        ,null localdebitamount_td --土地费用
        ,null localdebitamount_qq --前期工程费
        ,null localdebitamount_ja --建安工程费
        ,null localdebitamount_jc --基础设施费
        ,null localdebitamount_pt --配套设施费
        ,null localdebitamount_hj --环境景观工程费
        ,null localdebitamount_gcxg --工程相关费
        ,null localdebitamount_gcyg --工程预估成本
        ,null localdebitamount_gchx --工程后续成本
        ,null localdebitamount_kfjj --开发间接费转入
        ,null qp_amount_hs1 --nc取票金额（含税）
        ,null qp_amount --nc取票金额（不含税）
        ,null qp_amount_hs --nc取票金额（可抵扣税额）
        ,sum(nvl(creditamount, 0)) creditamount --贷方累计发生
        ,null x_amount --成本取票金额（含税）
        ,null x_amount_nontax --成本取票金额（不含税）
        ,null x_inputtax --成本取票金额（可抵扣税额）
        ,sum(nvl(debitamount, 0)) debitamount --借方累计发生（nc付款金额）
        ,nvl(applyamount_bz, 0) applyamount_bz --成本付款金额
        ,nvl(x_paymentamount, 0) x_paymentamount --合计
        ,nvl(x_paymentamount_xj, 0) x_paymentamount_xj --现金
        ,nvl(x_paymentamount_sp, 0) x_paymentamount_sp --商票
        ,nvl(x_paymentamount_bl, 0) x_paymentamount_bl --保理
        ,nvl(x_offsetamount_bz, 0) x_offsetamount_bz --扣罚款
        ,nvl(nov,'0') nov --凭证
        ,nvl(hx_nov,'0') hx_nov --核销凭证
        ,datekey --年月
        ,2 gz --规则
        ,case
           when to_char(sysdate-1 , 'dd') > t.datekey then
            '1'
           else
            '0'
         end issb --锁板标识
    from base t
  --科目为nc单位应付款（212102）-三栏式明细账-凭证-摘要抓取付款单号
  --（①剔除规则1中已抓取合同；②剔除【htfk】和包含【bx】付款编号）
   where djbh is not null
     and subjcode like '212102'
     and contractcode not in
         (select contractcode from base2 group by contractcode)
     and djbh not like '%htfk%'
     and djbh not like '%bx%'
  --and debitamount&lt;creditamount 
  --and debitamount&lt;&gt;0
   group by yearv
           ,periodv
           ,name --公司名称
           ,djbh
           ,explanation
           ,laiyuan
           ,nov
           ,hx_nov
           ,httypename
           ,contractname
           ,x_dfprovidernames
           ,jsstate
           ,datekey
           ,contractcode
           ,nvl(x_totalamount_inputtax, 0) --合同最新金额（含税）
           ,nvl(x_totalamount_nontax, 0) --合同最新金额（不含税）
           ,nvl(applyamount_bz, 0) --成本付款金额
           ,nvl(x_paymentamount, 0) --合计
           ,nvl(x_paymentamount_xj, 0) --现金
           ,nvl(x_paymentamount_sp, 0) --商票
           ,nvl(x_paymentamount_bl, 0) --保理
           ,nvl(x_offsetamount_bz, 0) --扣罚款
  ),
base4 as
 (select yearv --年
        ,periodv --月
        ,name company_name --公司名称
        ,nvl(t.djbh, explanation) djbh --单据编号
        ,explanation --摘要内容
        ,laiyuan --来源
        ,nvl(contractcode, explanation) contractcode --合同编号
        ,nvl(httypename, explanation) httypename --合同类别
        ,nvl(contractname, explanation) contractname --合同名称
        ,nvl(x_dfprovidernames, explanation) x_dfprovidernames --对方单位
        ,case
           when contractcode is null then
            null
           else
            jsstate
         end jsstate --结算状态
        ,null x_totalamount_tax --合同最新金额（含税）
        ,null x_totalamount_nontax --合同最新金额（不含税）
        ,nvl(fq1, '不分期') fq --分期
        ,null localdebitamount_jjfy --账面开发间接费用
        ,sum(nvl(localdebitamount_td, 0)) +
         sum(nvl(localdebitamount_qq, 0)) +
         sum(nvl(localdebitamount_ja, 0)) +
         sum(nvl(localdebitamount_jc, 0)) +
         sum(nvl(localdebitamount_pt, 0)) +
         sum(nvl(localdebitamount_hj, 0)) +
         sum(nvl(localdebitamount_gcxg, 0)) +
         sum(nvl(localdebitamount_gcyg, 0)) +
         sum(nvl(localdebitamount_gchx, 0)) +
         sum(nvl(localdebitamount_kfjj, 0)) localdebitamount --账面开发成本
        ,sum(nvl(localdebitamount_td, 0)) localdebitamount_td --土地费用
        ,sum(nvl(localdebitamount_qq, 0)) localdebitamount_qq --前期工程费
        ,sum(nvl(localdebitamount_ja, 0)) localdebitamount_ja --建安工程费
        ,sum(nvl(localdebitamount_jc, 0)) localdebitamount_jc --基础设施费
        ,sum(nvl(localdebitamount_pt, 0)) localdebitamount_pt --配套设施费
        ,sum(nvl(localdebitamount_hj, 0)) localdebitamount_hj --环境景观工程费
        ,sum(nvl(localdebitamount_gcxg, 0)) localdebitamount_gcxg --工程相关费
        ,sum(nvl(localdebitamount_gcyg, 0)) localdebitamount_gcyg --工程预估成本
        ,sum(nvl(localdebitamount_gchx, 0)) localdebitamount_gchx --工程后续成本
        ,sum(nvl(localdebitamount_kfjj, 0)) localdebitamount_kfjj --开发间接费转入
        ,sum(nvl(qp_amount, 0)) + sum(nvl(qp_amount_hs, 0)) qp_amount_hs1 --nc取票金额（含税）
        ,sum(nvl(qp_amount, 0)) qp_amount --nc取票金额（不含税）
        ,sum(nvl(qp_amount_hs, 0)) qp_amount_hs --nc取票金额（可抵扣税额）
        ,sum(nvl(creditamount, 0)) creditamount --贷方累计发生
        ,null x_amount --成本取票金额（含税）
        ,null x_amount_nontax --成本取票金额（不含税）
        ,null x_inputtax --成本取票金额（可抵扣税额）
        ,case when rank=1 then m.debitamount else 0 end  debitamount--借方累计发生（nc付款金额）
        ,null applyamount_bz --成本付款金额
        ,nvl(x_paymentamount, 0) x_paymentamount --合计
        ,nvl(x_paymentamount_xj, 0) x_paymentamount_xj --现金
        ,nvl(x_paymentamount_sp, 0) x_paymentamount_sp --商票
        ,nvl(x_paymentamount_bl, 0) x_paymentamount_bl --保理
        ,nvl(x_offsetamount_bz, 0) x_offsetamount_bz --扣罚款
        ,nvl(nov,'0') nov --凭证
        ,nvl(hx_nov,'0') hx_nov --核销凭证
        ,t.datekey --年月
        ,3 gz --规则
        ,case
           when to_char(sysdate-1 , 'dd') > t.datekey then
            '1'
           else
            '0'
         end issb --锁板标识
    from base t
    left join (select nvl(djbh, explanation) djbh,datekey
                    ,sum(nvl(debitamount, 0)) debitamount --借方累计发生
                from base
               where subjcode like '212102'
               group by djbh,explanation,datekey) m
      on t.djbh = m.djbh
   where t.djbh is null
     and subjcode like '4101%' --科目为nc开发成本（4101 ) 、无单号
   group by yearv
           ,periodv
           ,name --公司名称
           ,t.djbh
           ,explanation
           ,laiyuan
           ,nov
           ,hx_nov
           ,httypename
           ,contractname
           ,x_dfprovidernames
           ,jsstate
           ,t.datekey
           ,fq1
           ,contractcode
           ,m.debitamount
           ,nvl(x_paymentamount, 0) --合计
           ,nvl(x_paymentamount_xj, 0) --现金
           ,nvl(x_paymentamount_sp, 0) --商票
           ,nvl(x_paymentamount_bl, 0) --保理
           ,nvl(x_offsetamount_bz, 0) --扣罚款
           ,case when rank=1 then m.debitamount else 0 end
  ),
base5 as
 (select yearv --年
        ,periodv --月
        ,name company_name --公司名称
        ,nvl(djbh, explanation) djbh --单据编号
        ,explanation --摘要内容
        ,laiyuan --来源
        ,'0' contractcode --合同编号
        ,null httypename --合同类别
        ,'' contractname --合同名称
        ,null x_dfprovidernames --对方单位
        ,null jsstate --结算状态
        ,null x_totalamount_tax --合同最新金额（含税）
        ,null x_totalamount_nontax --合同最新金额（不含税）
        ,'不分期' fq --分期
        ,sum(nvl(debitamount, 0)) - sum(nvl(creditamount, 0)) localdebitamount_jjfy --账面开发间接费用
        ,null localdebitamount --账面开发成本
        ,null localdebitamount_td --土地费用
        ,null localdebitamount_qq --前期工程费
        ,null localdebitamount_ja --建安工程费
        ,null localdebitamount_jc --基础设施费
        ,null localdebitamount_pt --配套设施费
        ,null localdebitamount_hj --环境景观工程费
        ,null localdebitamount_gcxg --工程相关费
        ,null localdebitamount_gcyg --工程预估成本
        ,null localdebitamount_gchx --工程后续成本
        ,null localdebitamount_kfjj --开发间接费转入
        ,null qp_amount_hs1 --nc取票金额（含税）
        ,null qp_amount --nc取票金额（不含税）
        ,null qp_amount_hs --nc取票金额（可抵扣税额）
        ,sum(nvl(creditamount, 0)) creditamount --贷方累计发生
        ,null x_amount --成本取票金额（含税）
        ,null x_amount_nontax --成本取票金额（不含税）
        ,null x_inputtax --成本取票金额（可抵扣税额）
        ,null debitamount --借方累计发生（nc付款金额）
        ,null applyamount_bz --成本付款金额
        ,nvl(x_paymentamount, 0) x_paymentamount --合计
        ,nvl(x_paymentamount_xj, 0) x_paymentamount_xj --现金
        ,nvl(x_paymentamount_sp, 0) x_paymentamount_sp --商票
        ,nvl(x_paymentamount_bl, 0) x_paymentamount_bl --保理
        ,nvl(x_offsetamount_bz, 0) x_offsetamount_bz --扣罚款
        ,'0' nov --凭证
        ,'0' hx_nov --核销凭证
        ,datekey --年月
        ,4 gz --规则
        ,case
           when to_char(sysdate-1 , 'dd') > t.datekey then
            '1'
           else
            '0'
         end issb --锁板标识
    from base t
   where subjcode like '4105%' --科目为nc开发间接费用（4105
   group by yearv
           ,periodv
           ,name --公司名称
           ,nvl(djbh, explanation)
           ,explanation
           ,laiyuan
           ,datekey
           ,nvl(x_paymentamount, 0) --合计
           ,nvl(x_paymentamount_xj, 0) --现金
           ,nvl(x_paymentamount_sp, 0) --商票
           ,nvl(x_paymentamount_bl, 0) --保理
           ,nvl(x_offsetamount_bz, 0) --扣罚款
  )

select a.*
      ,case
         when nvl(qp_amount_hs1, 0) = nvl(x_amount, 0) then
          nvl(qp_amount_hs1, 0)
       end qpje_hs
      ,case
         when nvl(qp_amount, 0) = nvl(x_amount_nontax, 0) then
          nvl(qp_amount, 0)
       end qpje_bhs
      ,case
         when nvl(qp_amount_hs, 0) = nvl(x_inputtax, 0) then
          nvl(x_inputtax, 0)
       end qpje_kdk
      ,case
         when nvl(debitamount, 0) = nvl(applyamount_bz, 0) then
          nvl(debitamount, 0)
       end applyamount_bz_rg
  from (select *
          from base2
        union all
        select *
          from base3
        union all
        select *
          from base4
        union all
        select *
          from base5) a
          </sql>
    <limit>0</limit>
    <lookup />
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>208</xloc>
      <yloc>112</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>插入 / 更新</name>
    <type>InsertUpdate</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>oracle</connection>
    <commit>100</commit>
    <update_bypassed>N</update_bypassed>
    <lookup>
      <schema />
      <table>DW_CT_PROJECT_PAYMENT</table>
      <key>
        <name>DJBH</name>
        <field>DJBH</field>
        <condition>=</condition>
        <name2 />
      </key>
      <key>
        <name>CONTRACTCODE</name>
        <field>CONTRACTCODE</field>
        <condition>=</condition>
        <name2 />
      </key>
      <key>
        <name>FQ</name>
        <field>FQ</field>
        <condition>=</condition>
        <name2 />
      </key>
      <key>
        <name>DATEKEY</name>
        <field>DATEKEY</field>
        <condition>=</condition>
        <name2 />
      </key>
      <key>
        <name>COMPANY_NAME</name>
        <field>COMPANY_NAME</field>
        <condition>=</condition>
        <name2 />
      </key>
      <key>
        <name>NOV</name>
        <field>NOV</field>
        <condition>=</condition>
        <name2 />
      </key>
      <key>
        <name>HX_NOV</name>
        <field>HX_NOV</field>
        <condition>=</condition>
        <name2 />
      </key>
      <key>
        <name>EXPLANATION</name>
        <field>EXPLANATION</field>
        <condition>=</condition>
        <name2 />
      </key>
      <value>
        <name>YEARV</name>
        <rename>YEARV</rename>
        <update>N</update>
      </value>
      <value>
        <name>PERIODV</name>
        <rename>PERIODV</rename>
        <update>N</update>
      </value>
      <value>
        <name>DJBH</name>
        <rename>DJBH</rename>
        <update>N</update>
      </value>
      <value>
        <name>EXPLANATION</name>
        <rename>EXPLANATION</rename>
        <update>N</update>
      </value>
      <value>
        <name>LAIYUAN</name>
        <rename>LAIYUAN</rename>
        <update>N</update>
      </value>
      <value>
        <name>CONTRACTCODE</name>
        <rename>CONTRACTCODE</rename>
        <update>N</update>
      </value>
      <value>
        <name>HTTYPENAME</name>
        <rename>HTTYPENAME</rename>
        <update>N</update>
      </value>
      <value>
        <name>CONTRACTNAME</name>
        <rename>CONTRACTNAME</rename>
        <update>N</update>
      </value>
      <value>
        <name>X_DFPROVIDERNAMES</name>
        <rename>X_DFPROVIDERNAMES</rename>
        <update>N</update>
      </value>
      <value>
        <name>JSSTATE</name>
        <rename>JSSTATE</rename>
        <update>N</update>
      </value>
      <value>
        <name>X_TOTALAMOUNT_TAX</name>
        <rename>X_TOTALAMOUNT_TAX</rename>
        <update>Y</update>
      </value>
      <value>
        <name>X_TOTALAMOUNT_NONTAX</name>
        <rename>X_TOTALAMOUNT_NONTAX</rename>
        <update>Y</update>
      </value>
      <value>
        <name>FQ</name>
        <rename>FQ</rename>
        <update>N</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_JJFY</name>
        <rename>LOCALDEBITAMOUNT_JJFY</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT</name>
        <rename>LOCALDEBITAMOUNT</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_TD</name>
        <rename>LOCALDEBITAMOUNT_TD</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_QQ</name>
        <rename>LOCALDEBITAMOUNT_QQ</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_JA</name>
        <rename>LOCALDEBITAMOUNT_JA</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_JC</name>
        <rename>LOCALDEBITAMOUNT_JC</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_PT</name>
        <rename>LOCALDEBITAMOUNT_PT</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_HJ</name>
        <rename>LOCALDEBITAMOUNT_HJ</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_GCXG</name>
        <rename>LOCALDEBITAMOUNT_GCXG</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_GCYG</name>
        <rename>LOCALDEBITAMOUNT_GCYG</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_GCHX</name>
        <rename>LOCALDEBITAMOUNT_GCHX</rename>
        <update>Y</update>
      </value>
      <value>
        <name>LOCALDEBITAMOUNT_KFJJ</name>
        <rename>LOCALDEBITAMOUNT_KFJJ</rename>
        <update>Y</update>
      </value>
      <value>
        <name>QP_AMOUNT_HS1</name>
        <rename>QP_AMOUNT_HS1</rename>
        <update>Y</update>
      </value>
      <value>
        <name>QP_AMOUNT</name>
        <rename>QP_AMOUNT</rename>
        <update>Y</update>
      </value>
      <value>
        <name>QP_AMOUNT_HS</name>
        <rename>QP_AMOUNT_HS</rename>
        <update>Y</update>
      </value>
      <value>
        <name>CREDITAMOUNT</name>
        <rename>CREDITAMOUNT</rename>
        <update>Y</update>
      </value>
      <value>
        <name>X_AMOUNT</name>
        <rename>X_AMOUNT</rename>
        <update>Y</update>
      </value>
      <value>
        <name>X_AMOUNT_NONTAX</name>
        <rename>X_AMOUNT_NONTAX</rename>
        <update>Y</update>
      </value>
      <value>
        <name>X_INPUTTAX</name>
        <rename>X_INPUTTAX</rename>
        <update>Y</update>
      </value>
      <value>
        <name>DEBITAMOUNT</name>
        <rename>DEBITAMOUNT</rename>
        <update>Y</update>
      </value>
      <value>
        <name>APPLYAMOUNT_BZ</name>
        <rename>APPLYAMOUNT_BZ</rename>
        <update>Y</update>
      </value>
      <value>
        <name>X_PAYMENTAMOUNT</name>
        <rename>X_PAYMENTAMOUNT</rename>
        <update>Y</update>
      </value>
      <value>
        <name>X_PAYMENTAMOUNT_XJ</name>
        <rename>X_PAYMENTAMOUNT_XJ</rename>
        <update>Y</update>
      </value>
      <value>
        <name>X_PAYMENTAMOUNT_SP</name>
        <rename>X_PAYMENTAMOUNT_SP</rename>
        <update>Y</update>
      </value>
      <value>
        <name>X_PAYMENTAMOUNT_BL</name>
        <rename>X_PAYMENTAMOUNT_BL</rename>
        <update>Y</update>
      </value>
      <value>
        <name>X_OFFSETAMOUNT_BZ</name>
        <rename>X_OFFSETAMOUNT_BZ</rename>
        <update>Y</update>
      </value>
      <value>
        <name>NOV</name>
        <rename>NOV</rename>
        <update>N</update>
      </value>
      <value>
        <name>HX_NOV</name>
        <rename>HX_NOV</rename>
        <update>N</update>
      </value>
      <value>
        <name>DATEKEY</name>
        <rename>DATEKEY</rename>
        <update>N</update>
      </value>
      <value>
        <name>GZ</name>
        <rename>GZ</rename>
        <update>N</update>
      </value>
      <value>
        <name>ISSB</name>
        <rename>ISSB</rename>
        <update>Y</update>
      </value>
      <value>
        <name>COMPANY_NAME</name>
        <rename>COMPANY_NAME</rename>
        <update>N</update>
      </value>
      <value>
        <name>QPJE_HS</name>
        <rename>QPJE_HS</rename>
        <update>Y</update>
      </value>
      <value>
        <name>QPJE_BHS</name>
        <rename>QPJE_BHS</rename>
        <update>Y</update>
      </value>
      <value>
        <name>QPJE_KDK</name>
        <rename>QPJE_KDK</rename>
        <update>Y</update>
      </value>
      <value>
        <name>APPLYAMOUNT_BZ_RG</name>
        <rename>APPLYAMOUNT_BZ_RG</rename>
        <update>Y</update>
      </value>
    </lookup>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>448</xloc>
      <yloc>112</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
</transformation>
